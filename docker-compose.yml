version: '3.8'

services:
  # MongoDB Service (optional - can use MongoDB Atlas instead)
  mongodb:
    image: mongo:7.0
    container_name: documind-mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-changeme}
      MONGO_INITDB_DATABASE: ${MONGO_DATABASE:-documind_db}
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    networks:
      - documind-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
    profiles:
      - local-db  # Only start with --profile local-db

  # Redis Service (for Celery and caching)
  redis:
    image: redis:7-alpine
    container_name: documind-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - documind-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    command: redis-server --appendonly yes

  # MinIO Service (S3-compatible storage)
  minio:
    image: minio/minio:latest
    container_name: documind-minio
    restart: unless-stopped
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    networks:
      - documind-network
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    profiles:
      - local-storage  # Only start with --profile local-storage

  # Backend Service
  backend:
    build:
      context: ./documind-backend
      dockerfile: Dockerfile
    container_name: documind-backend
    restart: unless-stopped
    environment:
      # Application
      APP_NAME: ${APP_NAME:-DocuMind AI Backend}
      APP_VERSION: ${APP_VERSION:-1.0.0}
      DEBUG: ${DEBUG:-false}
      ENVIRONMENT: ${ENVIRONMENT:-production}
      
      # Server
      HOST: 0.0.0.0
      PORT: 8000
      
      # CORS
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:5173,http://localhost:3000}
      
      # Security
      SECRET_KEY: ${SECRET_KEY}
      ALGORITHM: ${ALGORITHM:-HS256}
      ACCESS_TOKEN_EXPIRE_MINUTES: ${ACCESS_TOKEN_EXPIRE_MINUTES:-30}
      REFRESH_TOKEN_EXPIRE_DAYS: ${REFRESH_TOKEN_EXPIRE_DAYS:-7}
      
      # Database
      DATABASE_URL: ${DATABASE_URL:-mongodb://mongodb:27017/documind_db}
      DATABASE_NAME: ${DATABASE_NAME:-documind_db}
      
      # Redis
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      
      # Storage
      STORAGE_PROVIDER: ${STORAGE_PROVIDER:-minio}
      STORAGE_ENDPOINT: ${STORAGE_ENDPOINT:-minio:9000}
      STORAGE_ACCESS_KEY: ${STORAGE_ACCESS_KEY:-minioadmin}
      STORAGE_SECRET_KEY: ${STORAGE_SECRET_KEY:-minioadmin}
      STORAGE_BUCKET_NAME: ${STORAGE_BUCKET_NAME:-documind}
      STORAGE_SECURE: ${STORAGE_SECURE:-false}
      
      # Embedding & LLM
      EMBEDDING_PROVIDER: ${EMBEDDING_PROVIDER:-openai}
      LLM_PROVIDER: ${LLM_PROVIDER:-openai}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      
      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOG_FORMAT: ${LOG_FORMAT:-json}
    ports:
      - "8000:8000"
    volumes:
      - backend_uploads:/app/uploads
      - backend_chromadb:/app/chroma_db
    networks:
      - documind-network
    depends_on:
      redis:
        condition: service_healthy
      mongodb:
        condition: service_healthy
        required: false  # Optional if using MongoDB Atlas
      minio:
        condition: service_healthy
        required: false  # Optional if using external storage
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8000/api/v1/health')"]
      interval: 30s
      timeout: 10s
      start_period: 40s
      retries: 3

  # Frontend Service
  frontend:
    build:
      context: ./documind-frontend
      dockerfile: Dockerfile
      args:
        VITE_API_URL: ${VITE_API_URL:-http://localhost:8000}
        VITE_APP_NAME: ${VITE_APP_NAME:-DocuMind AI}
    container_name: documind-frontend
    restart: unless-stopped
    ports:
      - "5173:80"
    networks:
      - documind-network
    depends_on:
      - backend
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 3s
      start_period: 5s
      retries: 3

volumes:
  mongodb_data:
    driver: local
  mongodb_config:
    driver: local
  redis_data:
    driver: local
  minio_data:
    driver: local
  backend_uploads:
    driver: local
  backend_chromadb:
    driver: local

networks:
  documind-network:
    driver: bridge
    name: documind-network

